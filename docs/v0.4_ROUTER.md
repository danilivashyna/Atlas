# v0.4 — Router: Path-Aware Routing with Hierarchical Memory

Path-aware routing via 5D encoding + hierarchical node scoring with soft child activation.

## Summary

- **Algorithm**: score = α·cosine + β·prior + γ·child_bonus; softmax for soft activation
- **Data Model**: Nodes stored in SQLite with (path, parent, vec5, label, weight, meta)
- **Endpoints**: POST `/router/route`, POST `/router/activate`
- **Feature flags**:
  - `ATLAS_ROUTER_MODE = on | off` (default: on)
  - `ATLAS_ROUTER_ALPHA=0.7`, `ATLAS_ROUTER_BETA=0.2`, `ATLAS_ROUTER_GAMMA=0.1`, `ATLAS_ROUTER_TAU=0.5`

## Data Model

### Nodes Table (SQLite)

```sql
CREATE TABLE nodes (
    path TEXT PRIMARY KEY,           -- e.g., "dim2/dim2.4/dim2.4.1"
    parent TEXT,                     -- e.g., "dim2/dim2.4" or NULL for root
    v1 REAL, v2 REAL, v3 REAL,      -- 5D vector components
    v4 REAL, v5 REAL,
    label TEXT,                      -- Human-readable label (optional)
    weight REAL DEFAULT 0.5,         -- Priority weight [0..1]
    meta TEXT                        -- JSON metadata
);

CREATE INDEX idx_nodes_parent ON nodes(parent);
CREATE INDEX idx_nodes_path ON nodes(path);
```

### Node Example

```json
{
  "path": "dim2/dim2.4",
  "parent": "dim2",
  "vec5": [0.5, 0.0, 0.3, 0.0, 0.2],
  "label": "домашнее-живое-позитив",
  "weight": 0.6,
  "meta": null
}
```

## Scoring Formula

For each node n, compute:

$$\text{score}(n) = \alpha \cdot \frac{\cos(v_{\text{text}}, n.vec5) + 1}{2} + \beta \cdot n.weight + \gamma \cdot \text{child\_bonus}$$

Where:
- **α** (default 0.7): Weight on cosine similarity (normalized [-1..1] → [0..1])
- **β** (default 0.2): Weight on node priority (n.weight)
- **γ** (default 0.1): Weight on child bonus (max score of children, or 0)
- **child_bonus**: Heuristic bonus if children score higher than node

### Soft Activation (Softmax)

For children of a node, apply softmax with temperature τ:

$$p_i = \frac{\exp(\text{score}_i / \tau)}{\sum_j \exp(\text{score}_j / \tau)}$$

Where τ (default 0.5) controls distribution sharpness.

## API

### POST /router/route

Route text to top-k nodes.

**Request:**

```json
{
  "text": "Cats chase mice",
  "top_k": 3
}
```

**Response:**

```json
{
  "items": [
    {
      "path": "dim2/dim2.4",
      "score": 0.83,
      "label": "домашнее-живое-позитив",
      "meta": null
    },
    {
      "path": "dim1/dim1.2",
      "score": 0.71,
      "label": "движение-активное",
      "meta": null
    }
  ],
  "trace_id": "a1b2c3d4"
}
```

**curl Example:**

```bash
curl -sS http://localhost:8010/router/route \
  -H 'Content-Type: application/json' \
  --data '{"text":"Cats are friendly pets","top_k":3}' | jq .
```

### POST /router/activate

Soft-activate children of a node.

**Request:**

```json
{
  "path": "dim2/dim2.4",
  "text": "Cats chase mice"
}
```

**Response:**

```json
{
  "children": [
    {"path": "dim2/dim2.4.1", "p": 0.62},
    {"path": "dim2/dim2.4.3", "p": 0.38}
  ],
  "trace_id": "e5f6g7h8"
}
```

Note: Probabilities sum to ~1.0 (softmax output).

**curl Example:**

```bash
curl -sS http://localhost:8010/router/activate \
  -H 'Content-Type: application/json' \
  --data '{"path":"dim2/dim2.4","text":"Cats are friendly"}' | jq .
```

## Usage Workflow

### 1. Load Nodes

Write nodes to database:

```python
from atlas.memory import get_node_store

store = get_node_store()

# Write nodes (typically done once, e.g., during initialization)
store.write_node(
    path="dim2",
    parent=None,
    vec5=[0.6, 0.0, 0.2, 0.0, 0.2],
    label="живое",
    weight=0.7
)

store.write_node(
    path="dim2/dim2.4",
    parent="dim2",
    vec5=[0.5, 0.0, 0.3, 0.0, 0.2],
    label="домашнее-живое-позитив",
    weight=0.6
)
```

Or via API (future): `POST /memory/load_nodes` from JSONL file.

### 2. Route Text

```bash
curl -X POST http://localhost:8010/router/route \
  -H 'Content-Type: application/json' \
  --data '{
    "text": "My cat loves to play with yarn",
    "top_k": 5
  }'
```

### 3. Activate Children

```bash
curl -X POST http://localhost:8010/router/activate \
  -H 'Content-Type: application/json' \
  --data '{
    "path": "dim2/dim2.4",
    "text": "Kittens are cute"
  }'
```

## Environment Configuration

```bash
# Enable/disable router
export ATLAS_ROUTER_MODE=on  # or 'off'

# Scoring weights
export ATLAS_ROUTER_ALPHA=0.7    # cosine weight
export ATLAS_ROUTER_BETA=0.2     # priority weight
export ATLAS_ROUTER_GAMMA=0.1    # child bonus weight
export ATLAS_ROUTER_TAU=0.5      # softmax temperature

# Memory backend (stores nodes)
export ATLAS_MEMORY_BACKEND=sqlite  # or 'inproc'

# Optionally use persistent database file
export ATLAS_MEMORY_BACKEND=sqlite
# (creates ~/.atlas_memory.db by default, or use custom db_path)
```

## Architecture

```
┌─────────────────────────────────────────┐
│         FastAPI App (app.py)            │
└────────────┬────────────────────────────┘
             │
             ├─→ POST /router/route
             │   └─→ router_routes.py::router_route()
             │       └─→ PathRouter.route()
             │           ├─→ SemanticSpace.encode()
             │           ├─→ get_node_store()
             │           └─→ score_node() for each node
             │
             └─→ POST /router/activate
                 └─→ router_routes.py::router_activate()
                     └─→ PathRouter.activate_child()
                         ├─→ SemanticSpace.encode()
                         ├─→ get_node_store().get_children(path)
                         └─→ softmax(scores)

┌─────────────────────────────────────────┐
│      PathRouter (path_router.py)        │
│  - route(text, top_k) → PathScore[]     │
│  - activate_child(path, text) → [...] │
│  - _score_node(vec, node) → float       │
│  - _cosine(v1, v2) → float              │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│   PersistentMemory (persistent.py)      │
│  - write_node(path, parent, vec5, ...) │
│  - get_children(parent_path)            │
│  - get_all_nodes()                      │
│  - knn_nodes(vec5, top_k)               │
│  - stats_nodes()                        │
│  - flush_nodes()                        │
└─────────────────────────────────────────┘
             │
             └─→ SQLite Database (nodes table)
```

## Limitations & Future Work

### v0.4 Limitations

- **No vector indexing**: O(n) similarity search; suitable for <10k nodes
- **Simple child bonus**: Heuristic max(child_scores); no learned ranking
- **No inference caching**: Each route() recomputes encoder + scores
- **No batch routing**: Single text at a time
- **Fixed env parameters**: Weights can only be set via env, not per-request

### Future Enhancements

- **Vector index** (ANN): FAISS or similar for O(log n) nearest neighbor
- **Learned router**: Fine-tune α, β, γ on labeled routing datasets
- **Batch API**: POST /router/route with batch of texts
- **Path priors**: Learn path-specific weights from usage data
- **Cache**: LRU cache for encoded vectors and node scores
- **Metrics**: Track routing accuracy, latency, cache hit rate
- **Node updates**: Dynamic node addition/removal without rebuild

## Testing

```bash
# Run router tests
pytest tests/test_router_api.py -v

# Specific tests
pytest tests/test_router_api.py::test_router_route_basic -v
pytest tests/test_router_api.py::test_router_activate_children -v
pytest tests/test_router_api.py::test_router_off_flag -v
```

## Backward Compatibility

- ✅ No breaking changes to `/encode`, `/decode`, `/explain`, `/summarize`
- ✅ No breaking changes to `/memory/*` (v0.3 API unchanged)
- ✅ No breaking changes to `/encode_h`, `/decode_h`, `/manipulate_h` (hierarchical)
- ✅ Router is optional: can be disabled via `ATLAS_ROUTER_MODE=off`

## References

- `src/atlas/router/path_router.py` — PathRouter implementation
- `src/atlas/api/router_routes.py` — FastAPI routes
- `src/atlas/memory/persistent.py` — Node storage (write_node, get_children, etc.)
- `src/atlas/memory/__init__.py` — get_node_store() factory
- `tests/test_router_api.py` — Test suite
