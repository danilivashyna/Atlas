name: Phase B CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  lint-format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install black ruff pylint mypy pytest pytest-cov uvicorn httpx prometheus-client
      - name: Ruff
        run: ruff check --output-format=github .
      - name: Black (check)
        run: black --check .
      - name: Pylint (thresholds)
        run: |
          pylint src/orbis_fab/*.py --fail-under=9.3 || true
          pylint src/atlas/metrics/*.py --fail-under=7.5 || true
      - name: MyPy (only safe subsets)
        run: |
          mypy --install-types --non-interactive src/orbis_fab src/atlas || true

  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pytest pytest-cov hypothesis prometheus-client
      - name: Run tests (flags off)
        env:
          AURIS_SELF: "off"
          AURIS_STABILITY: "off"
          AURIS_HYSTERESIS: "off"
          AURIS_METRICS_EXP: "off"
        run: |
          pytest -q
      - name: Coverage gates
        env:
          AURIS_SELF: "off"
          AURIS_STABILITY: "off"
          AURIS_HYSTERESIS: "off"
          AURIS_METRICS_EXP: "off"
        run: |
          pytest --cov=src --cov-report=term-missing --cov-report=json
          python -c 'import json; data = json.load(open("coverage.json")); tot = data["totals"]["percent_covered"]; print(f"Total coverage: {tot:.1f}%"); assert tot >= 85.0, f"Total coverage {tot}% < 85%"'

  exp-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install uvicorn httpx pytest prometheus-client
      - name: SELF resonance smoke
        env:
          AURIS_SELF: "on"
        run: |
          mkdir -p logs data
          python scripts/resonance_test.py
          test -f data/identity.jsonl
          python -c 'import re, pathlib; t = pathlib.Path("data/identity.jsonl").read_text(encoding="utf-8"); cnt = len(re.findall(r"\"kind\":\s*\"heartbeat\"", t)); print(f"Heartbeats: {cnt}"); assert cnt >= 5, f"heartbeats={cnt} < 5"'
      - name: Stability/Hysteresis probes
        env:
          AURIS_STABILITY: "on"
          AURIS_HYSTERESIS: "on"
          AURIS_METRICS_EXP: "on"
        run: |
          python scripts/stability_probe_exp.py
          python scripts/hysteresis_probe_exp.py
      - name: Spin API & scrape /metrics/exp
        env:
          AURIS_METRICS_EXP: "on"
        run: |
          uvicorn atlas.api.app:app --port 8000 --log-level error &
          UV_PID=$!
          sleep 2
          python -c 'import httpx; r = httpx.get("http://127.0.0.1:8000/metrics/exp", timeout=5.0); assert r.status_code == 200, f"Status: {r.status_code}"; text = r.text; needed = ["atlas_stability_score", "atlas_stability_score_ema", "atlas_recommended_fab_mode", "atlas_hyst_switch_rate_per_sec", "atlas_hyst_oscillation_rate_per_sec"]; missing = [m for m in needed if m not in text]; assert not missing, f"missing metrics: {missing}"; print("âœ“ metrics OK")'
          kill $UV_PID || true
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: exp-logs
          path: |
            data/identity.jsonl
            logs/resonance_trace.jsonl
          retention-days: 7
